name: Auto PR for agent branches

on:
  push:
    branches:
      - "agent/**"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest
  steps:
  - name: Create PR
    uses: actions/github-script@v7
    with:
    github-token: ${{ secrets.GITHUB_TOKEN }}
    script: |
      const owner = context.repo.owner;
      const repo = context.repo.repo;

      // branch that triggered this workflow
      const head = (context.ref || "").replace("refs/heads/", "");
      if (!head) {
        core.setFailed("Could not determine head branch from context.ref");
        return;
      }

      // base branch (defaults to repo default branch)
      const repoInfo = await github.rest.repos.get({ owner, repo });
      const base = repoInfo.data.default_branch;

      // If there's already an open PR from this branch, do nothing
      const existing = await github.rest.pulls.list({
        owner,
        repo,
        state: "open",
        head: owner + ":" + head,
      });

      if (existing.data.length > 0) {
        core.info("PR already exists: " + existing.data[0].html_url);
        return;
      }

      const title = "Agent: " + head;
      const body = "Auto-created PR for branch `" + head + "`.";

      const pr = await github.rest.pulls.create({
        owner,
        repo,
        head,
        base,
        title,
        body,
        draft: true,
      });

      core.info("Created PR: " + pr.data.html_url);   