name: Auto PR for agent branches

on:
  push:
    branches:
      - "agent/**"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  create_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create PR (if missing)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = context.ref.replace("refs/heads/", "");
            const base = "main";

            // Don't create PRs for main itself, just in case
            if (head === base) {
              core.info(`Head is base branch (${base}); skipping PR creation.`);
              return;
            }

            // Check if a PR already exists for this head->base
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: "open",
              head: `${owner}:${head}`,
              base,
              per_page: 50,
            });

            if (prs.length > 0) {
              core.info(`PR already exists: ${prs[0].html_url}`);
              return;
            }

            // Create a PR
            const title = `Agent: ${head}`;
            const body = [
              "This PR was opened automatically from an agent-generated branch.",
              "",
              `**Branch:** \`${head}\``,
              `**Base:** \`${base}\``,
              "",
              "Review the changes, run the app, then merge when ready.",
            ].join("\n");

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              head,
              base,
              title,
              body,
              draft: false,
            });

            core.info(`Created PR: ${pr.html_url}`);